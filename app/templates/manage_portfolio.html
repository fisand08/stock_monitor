{% extends "base.html" %}

{% block content %}
    <div class="left-section">
        <h2>Add Portfolio</h2>
        <form id="portfolio-form" method="POST">
            {{ form.hidden_tag() }}
            <div class="form-group">
                <div class="label-wrapper">
                    {{ form.portfolios.label(class="form-control-label") }}
                </div>
                {{ form.portfolios(class="form-control narrow", id="portfolio-dropdown") }}
            </div>
            <div class="form-group">
                <div class="label-wrapper">
                    {{ form.stock.label(class="form-control-label") }}
                </div>
                {{ form.stock(class="form-control narrow", id="stock-dropdown") }}
            </div>
            <div class="form-group">
                <div class="label-wrapper">
                    {{ form.amount.label(class="form-control-label") }}
                </div>
                {{ form.amount(class="form-control narrow") }}
            </div>
            <div class="form-group">
                <div class="label-wrapper">
                    {{ form.action.label(class="form-control-label") }}
                </div>        
            <div>
                    {% for subfield in form.action %}
                        <div class="form-check form-check-inline">
                            {{ subfield(class="form-check-input") }}
                            {{ subfield.label(class="form-check-label") }}
                        </div>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <div class="middle-section">
        <h2>Stocks in portfolio</h2>
        <div id="current-stocks">
            <!-- Dynamic content will be inserted here -->
        </div>
    </div>


    <div class="right-section">
        <h2>Stock data</h2>
        <p id="current_stock">  </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var portfolioDropdown = document.getElementById('portfolio-dropdown');
            var stockDropdown = document.getElementById('stock-dropdown');
            var currentStockElement = document.getElementById('current_stock');
            
            function updateCurrentStock(selectedStockId) {
                // Make AJAX request to fetch selected stock's name
                var stockXhr = new XMLHttpRequest();
                stockXhr.open('GET', '/get_selected_stock_name/' + selectedStockId, true);
                stockXhr.onreadystatechange = function () {
                    if (stockXhr.readyState == 4 && stockXhr.status == 200) {
                        var responseData = JSON.parse(stockXhr.responseText);
                        var stockName = responseData.stock_name;
                        currentStockElement.innerHTML = stockName;
                    }
                };
                stockXhr.send();
            }
            
            if (portfolioDropdown && stockDropdown) {
                portfolioDropdown.addEventListener('change', function () {
                    var selectedPortfolioId = this.value;
                    if (selectedPortfolioId) {
                        var xhr = new XMLHttpRequest();
                        xhr.open('GET', '/get_portfolio_data/' + selectedPortfolioId, true);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                document.getElementById('current-stocks').innerHTML = xhr.responseText;
                                var selectedStockId = stockDropdown.value;
                                updateCurrentStock(selectedStockId);
                            }
                        };
                        xhr.send();
                    }
                });
                
                stockDropdown.addEventListener('change', function () {
                    var selectedStockId = this.value;
                    updateCurrentStock(selectedStockId);
                });
                
                portfolioDropdown.dispatchEvent(new Event('change'));
            }
        });
    </script>
    
    
    
{% endblock %}
